var wellClient=function(e){function n(e,n){var t=s.render(this.path,e);return s.sendRequest(t,this.method,n)}var t=function(){};t.pt=t.prototype;var c={debug:!0,useWsLog:!0,SDK:"cmbyc.wellcloud.cc",cstaPort:"8088",eventPort:"8088",eventBasePath:"/mvc/stomp",cstaBasePath:"/api/csta",clickCallClass:"well-canBeCalled",timeout:5,maxReconnectTimes:5,currentReconnectTimes:0,TPI:"cmbyc.wellcloud.cc:5003/login",isLogined:!1,heartbeatLength:12e4,heartbeatId:"",enableAlert:!1},l={length:0},i={setAgentState:{desc:"设置坐席状态，登录与登出",path:"/agent/state",method:"post",status:{204:"成功",401:"密码不匹配",451:"分机未注册",453:"非法分机号",454:"分机已被登录",455:"坐席已经登录",456:"分机状态",457:"未授权分机",461:"在线坐席超过最大限制"},fire:n},heartbeat:{desc:"坐席心跳",path:"/agent/heartbeat/{{agentId}}",method:"post",fire:n},makeCall:{desc:"呼出电话",path:"/callControl/calls",method:"post",fire:n},answerCall:{desp:"接电话",path:"/callControl/calls/{{callId}}/connections/{{connectionId}}/answer",method:"post",fire:n},dropConnection:{desp:"挂断链接",path:"/callControl/calls/{{callId}}/connections/{{connectionId}}",method:"delete",fire:n},holdCall:{desp:"保持电话",path:"/callControl/calls/{{callId}}/connections/{{connectionId}}/hold",method:"post",fire:n},retrieveCall:{desp:"取回电话",path:"/callControl/calls/{{callId}}/connections/{{connectionId}}/retrieve",method:"post",fire:n},singleStepTransfer:{desp:"单步转移",path:"/callControl/calls/{{callId}}/connections/{{connectionId}}/singleStepTransfer",method:"post",fire:n},singleStepConference:{desp:"单步会议",path:"/callControl/calls/{{callId}}/connections/{{connectionId}}/singleStepConference",method:"post",fire:n},consult:{desp:"咨询",path:"/callControl/calls/{{callId}}/connections/{{connectionId}}/consult",method:"post",fire:n},conference:{desp:"咨询",path:"/callControl/calls/{{callId}}/connections/{{connectionId}}/conference",method:"post",fire:n},cancelConsult:{desp:"取消咨询",path:"/callControl/calls/{{callId}}/connections/{{connectionId}}/cancelConsult",method:"post",fire:n},transferCall:{desp:"咨询后转移",path:"/callControl/calls/{{callId}}/connections/{{connectionId}}/transfer",method:"post",fire:n},setCallData:{desp:"设置随路数据",path:"/callControl/calls/{{callId}}/user-data",method:"post",fire:n},spy:{desp:"监听设备",path:"/callControl/calls/{{callId}}/spy?deviceId={{deviceId}}",method:"post",fire:n}},a={number:"",password:"000000",domain:"sinosig.test",ext:"8002"},o={user:{},sessionId:""},r={},d={},s={render:function(e,n){for(var t=/{{([^}]+)?}}/g,c="";c=t.exec(e);)e=e.replace(c[0],n[c[1]]);return e},clearCache:function(){r.logined||(o={user:{},sessionId:""},l={})},log:function(e){c.debug&&console.info(e),t.pt.outputLog({type:"log",content:"object"==typeof e?JSON.stringify(e):e})},error:function(e){if(c.debug)try{throw new Error(e)}catch(e){console.error(e)}t.pt.outputLog({type:"error",content:"object"==typeof e?JSON.stringify(e):e})},alert:function(e){c.debug&&console.error(e),t.pt.outputLog({type:"alert",content:"object"==typeof e?JSON.stringify(e):e})},typeof:function(e){return typeof e},getErrorMsg:function(e,n){return i[e].status[n]||""},isPhoneNumber:function(e){return"string"===s.typeof(e)&&/^\d+$/.test(e)},sendRequest:function(n,t,l){return e.ajax({url:"http://"+c.SDK+":"+c.cstaPort+c.cstaBasePath+n,type:t||"get",headers:{sessionId:o.sessionId||""},data:JSON.stringify(l),dataType:"json",contentType:"application/json; charset=UTF-8"})},sendRequestSync:function(n,t,l){var i=e.Deferred();return e.ajax({url:"http://"+c.SDK+":"+c.cstaPort+c.cstaBasePath+n,type:t||"get",headers:{sessionId:o.sessionId||""},async:!1,data:JSON.stringify(l),dataType:"json",contentType:"application/json; charset=UTF-8",success:function(e){i.resolve(e)},error:function(e){i.reject(e)}}),i.promise()},TPILogin:function(n,t,l){var i=e.Deferred(),a="http://"+c.TPI,o="username="+n+"&password="+t+"&namespace="+l;return e.ajax({url:a,type:"post",data:o,dataType:"json",contentType:"application/x-www-form-urlencoded",success:function(e){i.resolve(e)},error:function(e){i.reject(e)}}),i.promise()},setAgentState:function(n){var t=e.Deferred(),c=i.setAgentState.method,l=i.setAgentState.path;return s.sendRequest(l,c,n).done(function(e){t.resolve(e)}).fail(function(e){t.reject(e)}),t.promise()},setAgentStateSync:function(n){var t=e.Deferred(),c=i.setAgentState.method,l=i.setAgentState.path;return s.sendRequestSync(l,c,n).done(function(e){t.resolve(e)}).fail(function(e){t.reject(e)}),t.promise()},login:function(n){var c=e.Deferred(),l={loginId:o.loginId,device:o.deviceId,password:o.user.password,agentMode:"Ready",func:"Login"};return s.setAgentState(l).done(function(e){s.log("登录成功"),s.initSoftPhone(),c.resolve(e)}).fail(function(e){if(n=n||"ask","454"==e.status)if("stop"===n)s.closeWebSocket(),c.reject(e);else if("ask"===n){var l=confirm("分机已经在别的地方登录，或者上次分机忘记登出，是否强制登录");l?(r.logined=!0,t.pt.logout(!1).done(function(e){s.login().done(function(e){c.resolve()})})):(s.closeWebSocket(),c.reject(e))}else"force"===n&&(r.logined=!0,t.pt.logout(!1).done(function(e){s.login().done(function(e){c.resolve()})}));else{var i=s.getErrorMsg("setAgentState",e.status);s.log(i),s.closeWebSocket(),c.reject(e)}}),c.promise()},initWebSocket:function(){var e="http://"+c.SDK+":"+c.eventPort+c.eventBasePath,n=new SockJS(e);d=Stomp.over(n),c.useWsLog||(d.debug=null),d.connect({},function(e){c.currentReconnectTimes=0;var n="/topic/csta/agent/"+o.loginId;d.subscribe(n,function(e){var n=JSON.parse(e.body);u.deliverEvent(n)})},function(e){console.log(e),console.error(new Date+"websocket失去连接"),c.currentReconnectTimes<c.maxReconnectTimes&&(c.currentReconnectTimes++,s.reconnectWs())})},reconnectWs:function(){setTimeout(function(){console.log(">>> 尝试重连websocket"),s.initWebSocket()},1e3*c.timeout)},closeWebSocket:function(){e.isFunction(d.disconnect)&&d.disconnect(function(e){s.log(e)})},clickCallListening:function(n){e(document).on("click","."+n,function(n){n.stopPropagation();var t=e(n.currentTarget).text().replace(/\D/g,"");e("#well-number").val(t),e("#well-make").trigger("click")})},initSoftPhone:function(){s.clickCallListening(c.clickCallClass),window.onunload=function(){s.closeWebSocket();var e={func:"Logout",device:o.deviceId,namespace:o.user.domain};s.setAgentStateSync(e)}}},u={deliverEvent:function(n){"ChannelStateChangedEvent"!==n.eventName&&s.log(n);var t=v[n.eventName];e.isFunction(t)&&t(n),e.isFunction(wellClient.exports)&&wellClient.exports(n)}},f={deliverEvent:function(n){var t=f[n.eventName];e.isFunction(t)&&t(n)}},v={agentLoggedOn:function(e){c.isLogined=!0;var n={eventName:"agentLoggedOn",deviceId:e.deviceId};wellClient.ui.main(n),t.pt.heartbeat(),c.heartbeatId=setInterval(function(){t.pt.heartbeat()},c.heartbeatLength)},agentWorkingAfterCall:function(e){wellClient.ui.main({eventName:"agentWorkingAfterCall"})},agentLoggedOff:function(e){c.isLogined&&(window.onunload=null,s.closeWebSocket(),clearInterval(c.heartbeatId),s.clearCache(),wellClient.ui.main({eventName:"agentLoggedOff"}))},agentReady:function(e){wellClient.ui.main({eventName:"agentReady"})},agentNotReady:function(e){wellClient.ui.main({eventName:"agentNotReady"})},serviceInitiated:function(e){l[e.callId]||(l[e.callId]={deviceCount:0},l.length++,l[e.callId][o.deviceId]={device:o.deviceId,connectionState:"initiated",callId:e.callId,isCalling:!0,callingDevice:e.callingDevice,calledDevice:e.calledDevice},l[e.callId].deviceCount++,l[e.callId].createTimeId=(new Date).valueOf())},originated:function(e){if(!l[e.callId][e.calledDevice]){var n=l[e.callId][e.callingDevice];n.connectionState="originated",n.callingDevice=e.callingDevice,n.calledDevice=e.calledDevice,l[e.callId][e.calledDevice]={device:e.calledDevice,connectionState:"unknown",callId:e.callId,isCalling:!1,callingDevice:e.callingDevice,calledDevice:e.calledDevice},l[e.callId].deviceCount++,wellClient.ui.main({eventName:"originated",deviceId:e.calledDevice,callId:e.callId})}},delivered:function(e){l[e.callId]?l[e.callId][e.calledDevice]?(l[e.callId][e.calledDevice].connectionState="alerting",wellClient.ui.main({eventName:"delivered",deviceId:e.calledDevice,callId:e.callId,isCalling:!0})):(l[e.callId][e.calledDevice]={device:e.calledDevice,connectionState:"delivered",callId:e.callId,isCalling:!0,callingDevice:e.callingDevice,calledDevice:e.calledDevice},l[e.callId].deviceCount++,wellClient.ui.main({eventName:"delivered",deviceId:e.calledDevice,callId:e.callId,isCalling:!0})):(l[e.callId]={deviceCount:0,createTimeId:(new Date).valueOf()},l.length++,l[e.callId][o.deviceId]={device:o.deviceId,connectionState:"alerting",callId:e.callId,isCalling:!1,callingDevice:e.callingDevice,calledDevice:e.calledDevice},l[e.callId].deviceCount++,l[e.callId][e.callingDevice]={device:e.callingDevice,connectionState:"originated",callId:e.callId,isCalling:!0,callingDevice:e.callingDevice,calledDevice:e.calledDevice},l[e.callId].deviceCount++,wellClient.ui.main({eventName:"delivered",deviceId:e.callingDevice,callId:e.callId,isCalling:!1}))},ChannelStateChangedEvent:function(e){},established:function(e){if(l[e.callId]){l[e.callId][e.callingDevice].connectionState=l[e.callId][e.calledDevice].connectionState="connected";var n=e.callingDevice===o.deviceId?e.calledDevice:e.callingDevice;wellClient.ui.main({eventName:"established",deviceId:n,device:n.split("@")[0],callId:e.callId})}},connectionCleared:function(e){if(l[e.callId]){var n="connected"===l[e.callId][e.releasingDevice].connectionState,t=l[e.callId].createTimeId,c={isEstatblished:n,createTimeId:t,event:e,eventName:"connectionCleared"};if(e.releasingDevice===o.deviceId){var i=l[e.callId][o.deviceId],a=i.isCalling?i.calledDevice:i.callingDevice,r=!1;l[e.callId].isConferenced&&(r=!0),delete l[e.callId],l.length--,wellClient.ui.main({eventName:"connectionCleared",deviceId:a,isClearAll:r})}else l[e.callId][e.releasingDevice]&&(delete l[e.callId][e.releasingDevice],l[e.callId].deviceCount--,wellClient.ui.main({eventName:"connectionCleared",deviceId:e.releasingDevice}));f.deliverEvent(c)}},held:function(e){if(l[e.callId]){var n=l[e.callId][o.deviceId],t=n.isCalling?n.calledDevice:n.callingDevice;n.connectionState="held",wellClient.ui.main({eventName:"held",device:t.split("@")[0],deviceId:t})}},retrieved:function(e){if(l[e.callId]){var n=l[e.callId][o.deviceId],t=n.isCalling?n.calledDevice:n.callingDevice;n.connectionState="connected",wellClient.ui.main({eventName:"retrieved",device:t.split("@")[0],deviceId:t})}},conferenced:function(e){if(!l[e.callId]&&l[e.primaryOldCall]){var n=l[e.primaryOldCall],t=n[o.deviceId].callingDevice,c=n[o.deviceId].calledDevice;l[e.callId]={deviceCount:2};var i=l[e.callId];i.isConferenced=!0,i[t]={callId:e.callId,calledDevice:c,callingDevice:t,connectionState:"connected",device:t,isCalling:!0},i[c]={callId:e.callId,calledDevice:c,callingDevice:t,connectionState:"connected",device:c,isCalling:!1},delete l[e.primaryOldCall]}if(l[e.callId]&&l[e.primaryOldCall]){var a=l[e.primaryOldCall],i=l[e.callId],r=a[o.deviceId].isCalling?a[o.deviceId].calledDevice:a[o.deviceId].callingDevice;i[r]={callId:e.callId,calledDevice:a.calledDevice,callingDevice:a.callingDevice,connectionState:"connected",device:r,isCalling:a.isCalling},delete l[e.primaryOldCall],l.length--,i.deviceCount++}l[e.callId].isConferenced=!0,l.length,wellClient.ui.main({eventName:"conferenced",callId:e.callId})}};return t.pt.on=function(e,n){u[e]=n},t.pt.innerOn=function(e,n){f[e]=n},t.pt.getCallMemory=function(){return l},t.pt.trigger=function(e,n){s[e](n)},t.pt.log=function(e){s.log(e)},t.pt.error=function(e){s.error(e)},t.pt.setDebug=function(e){c.debug=e||!0},t.pt.setConfig=function(n){if(c.debug=!1!==n.debug&&c.debug,c.SDK=n.SDK||c.SDK,c.cstaPort=n.cstaPort||c.cstaPort,c.eventPort=n.eventPort||c.eventPort,c.eventBasePath=n.eventBasePath||c.eventBasePath,c.TPI=n.TPI||c.TPI,c.cstaBasePath=n.cstaBasePath||c.cstaBasePath,c.useWsLog=!1!==n.useWsLog&&c.useWsLog,c.clickCallClass=n.clickCallClass||c.clickCallClass,c.hideButton=n.hideButton||[],c.hideButton.length>0){var t=c.hideButton.map(function(e){return"#well-"+e});t=t.join(),e(t).addClass("well-dn")}},t.pt.login=function(n,t,c,l,i){var r=e.Deferred();return o.user.number=e("#agentId").val(),o.user.password=t||a.password,o.user.domain=c||a.domain,o.user.ext=l||a.ext,o.loginId=o.user.number+"@"+o.user.domain,o.deviceId=o.user.ext+"@"+o.user.domain,s.TPILogin(o.user.number,o.user.password,o.user.domain).done(function(e){o.sessionId=e.sessionId,s.initWebSocket(),s.login(i).done(function(e){r.resolve(e)}).fail(function(e){r.reject(e)})}).fail(function(e){s.error("登录失败，请检查用户名、密码、域名是否正确"),r.reject(e)}),r.promise()},t.pt.logout=function(n){window.onunload=null,clearInterval(c.heartbeatId),n=!1!==n;var t=e.Deferred(),l={func:"Logout",device:o.deviceId,namespace:o.user.domain};return s.setAgentState(l).done(function(e){t.resolve(e),n&&s.closeWebSocket()}).fail(function(e){t.reject(e)}),t.promise()},t.pt.setAgentMode=function(n){var t=e.Deferred();if("Ready"===n||"NotReady"===n){var c={func:"SetState",device:o.deviceId,agentMode:n,namespace:o.user.domain};s.setAgentState(c).done(function(e){t.resolve(e)}).fail(function(e){t.reject(e)})}else s.error("参数必须是Ready或者NotReady");return t.promise()},t.pt.outputLog=function(n){e.isFunction(wellClient.onLog)&&wellClient.onLog(n)},t.pt.forceDrop=function(e,n){if("string"==typeof e&&"string"==typeof n){var t={callId:n,connectionId:e+"|"+n};return i.dropConnection.fire(t)}},t.pt.forceJoin=function(e,n,t){if("string"==typeof e&&"string"==typeof n&&"string"==typeof t){var c={callId:n,connectionId:e+"|"+n},l={conferenceParticipant:t,participationType:"Active"};return i.singleStepConference.fire(c,l)}},t.pt.forceTake=function(e,n,t){if("string"==typeof e&&"string"==typeof n&&"string"==typeof t){var c={callId:n,connectionId:e+"|"+n},l={transferTo:t};return i.singleStepTransfer.fire(c,l)}},t.pt.forceListen=function(e,n){if("string"==typeof n&&"string"==typeof e){var t={callId:e,deviceId:n};return i.spy.fire(t)}},t.pt.forceReady=function(e,n){if("string"==typeof n&&"string"==typeof e){var t={},c={func:"SetState",agentMode:"Ready",loginId:e,agentId:e,device:n};return i.setAgentState.fire(t,c)}},t.pt.forceNotReady=function(e,n){if("string"==typeof n&&"string"==typeof e){var t={},c={func:"SetState",agentMode:"NotReady",loginId:e,agentId:e,device:n};return i.setAgentState.fire(t,c)}},t.pt.forceLogout=function(e,n){if("string"==typeof n&&"string"==typeof e){var t={},c={namespace:e.split("@")[1],func:"Logout",device:n,agentId:e,loginId:e};return i.setAgentState.fire(t,c)}},t.pt.setCallData=function(e,n){e=e||"",n=n||{};var t={callId:e},c={entries:n};return i.setCallData.fire(t,c)},t.pt.heartbeat=function(){var e={agentId:o.loginId};return i.heartbeat.fire(e)},t.pt.transferCall=function(e,n){e=e||"",n=n||"";var t={callId:e,connectionId:o.deviceId+"|"+e},c={consultCallId:n};return i.transferCall.fire(t,c)},t.pt.cancelConsult=function(e,n){e=e||"",n=n||"";var t={callId:e,connectionId:o.deviceId+"|"+e},c={consultCallId:n};return i.cancelConsult.fire(t,c)},t.pt.conference=function(e,n){e=e||"",n=n||"";var t={callId:e,connectionId:o.deviceId+"|"+e},c={consultCallId:n};return i.conference.fire(t,c)},t.pt.consult=function(e,n){e=e||"",n=n||"";var t={callId:e,connectionId:o.deviceId+"|"+e},c={consultationParticipant:n};return i.consult.fire(t,c)},t.pt.singleStepConference=function(e,n,t){e=e||"",n=n||"",t=t||"";var c={callId:e,connectionId:o.deviceId+"|"+e},l={conferenceParticipant:n,participationType:t||"Active"};return i.singleStepConference.fire(c,l)},t.pt.singleStepTransfer=function(e,n){e=e||"",n=n||"";var t={callId:e,connectionId:o.deviceId+"|"+e},c={transferTo:n};return i.singleStepTransfer.fire(t,c)},t.pt.retrieveCall=function(e){e=e;var n={callId:e,connectionId:o.deviceId+"|"+e};return i.retrieveCall.fire(n)},t.pt.holdCall=function(e){e=e||"";var n={callId:e,connectionId:o.deviceId+"|"+e};return i.holdCall.fire(n)},t.pt.dropConnection=function(n){n=n||"";var t=(e.Deferred(),{callId:n,connectionId:o.deviceId+"|"+n});return i.dropConnection.fire(t)},t.pt.answerCall=function(e){e=e||"";var n={callId:e,connectionId:o.deviceId+"|"+e};return i.answerCall.fire(n)},t.pt.makeCall=function(e,n){if(n=n||{},s.isPhoneNumber(e)){if(e!==o.user.ext){var t={from:o.deviceId,to:n.prefix||""+e};return i.makeCall.fire({},t)}s.error("请勿输入自己的号码")}else s.error("输入号码不合法")},t.pt.get=function(n){return e(n)},t.pt.getCache=function(){return r},t.pt.render=function(e,n){for(var t=/{{([^}]+)?}}/g,c="";c=t.exec(e);)e=e.replace(c[0],n[c[1]]);return e},t.pt.isPhoneNumber=function(e){return s.isPhoneNumber(e)},t.pt.isFunction=function(e){return"[object Function]"===Object.prototype.toString.call(e)},t.pt.isArray=function(e){return"[object Array]"===Object.prototype.toString.call(e)},t.pt.findItem=function(e,n,c){if(!t.pt.isArray(e))return!1;if("string"!=typeof n)return!1;if(void 0===c)return!1;for(var l=0;l<e.length;l++)if(e[l][n]===c)return l;return-1},new t}(jQuery);