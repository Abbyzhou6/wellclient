!function(){var e=location.href,t=/file:|coding/.test(e);if(window.localStorage&&t){var l=localStorage.getItem("code");l&&$("#well-code").val(l);var n=localStorage.getItem("password");n&&$("#well-password").val(n);var a=localStorage.getItem("namespace");a&&$("#well-namespace").val(a);var i=localStorage.getItem("deviceId");i&&$("#well-deviceId").val(i);var s=localStorage.getItem("sdk");s&&$("#sdk").val(s);var r=localStorage.getItem("port");r&&$("#port").val(r);var c=localStorage.getItem("tpi");c&&$("#tpi").val(c)}}(),function(e,t){var l=e(document),n=[];l.on("change","#well-changestate",function(l){var n=e(this),a=n.val(),i="",s="";n.hasClass("well-disabled")||""===a||(i=a.split(":")[0],s=a.split(":")[1],t.setAgentMode(i,s).fail(function(e){460===e.status&&t.ui.status.renderAgentStatus()}),n.val(""))}),t.ui={},t.ui.status={agentStatus:"",deviceStatus:"",mixStatus:"",statusList:{agentReady:"就绪",agentNotReady:"示忙",agentWorkingAfterCall:"话后处理",agentLoggedOff:"未登录",agentAllocated:"预占中",agentLoggedOn:"已登录",originated:"呼出中",delivered:"振铃中",established:"通话中",held:"保持中",conferenced:"会议中",retrieved:"通话中"},renderAgentStatus:function(e){"agentNotReady"===this.agentStatus?"2"===e?t.ui.manualCallOut():t.ui.setAgentStateNotReady():"agentReady"===this.agentStatus?t.ui.setAgentStateReady():"agentWorkingAfterCall"===this.agentStatus&&t.ui.setAgentStateNotReady()},receiveEvent:function(e,t){/agent/.test(e)?(this.agentStatus=e,this.mixStatus=e):"connectionCleared"===e?(this.deviceStatus=e,this.mixStatus=this.agentStatus):(this.deviceStatus=e,this.mixStatus=this.deviceStatus),this.renderCurrentStatus(),this.renderAgentStatus(t)},transferStatus:function(e){return this.statusList[e]?this.statusList[e]:""},renderCurrentStatus:function(){var e=this.mixStatus;e=this.transferStatus(e),t.ui.setAgentNowState(e)}},t.ui.getCallModel=function(){return n},t.ui.removeOneCall=function(e){n.splice(e,1)},t.ui.manualCallOut=function(){e("#well-changestate").val("NotReady:2"),this.setAgentNowState("手工外呼")},t.ui.main=function(e){var l=e.eventName;"function"==typeof t.ui[l]&&t.ui[l](e)},t.ui.setPendingMode=function(t){console.log("come in wellClient.ui.setPendingMode"),e("#well-changestate").addClass("well-pending")},t.ui.removePendingMode=function(){e("#well-changestate").removeClass("well-pending")},t.ui.wsDisconnected=function(e){this.setAgentNowState("WebSocket已断开")},t.ui.agentAllocated=function(e){this.status.receiveEvent(e.eventName)},t.ui.setAgentNowState=function(t){e("#well-now-state").text(t)},t.ui.getAgentNowState=function(){return e("#well-now-state").text()},t.ui.getBtns=function(t){var l="#well-"+t.join(",#well-");return e(l)},t.ui.enableBtn=function(e){this.getBtns(e).removeClass("well-disabled")},t.ui.clearPhoneNumber=function(){e("#well-input").val("")},t.ui.getPhoneNumber=function(){var t=e("#well-phone-number"),l=t.val();return""===(l=e.trim(l))?(this.createWebNotification("未选择对方号码"),!1):(t.val(""),l)},t.ui.disabledBtn=function(e){this.getBtns(e).addClass("well-disabled")},t.ui.handleDeliveredState=function(){this.getActiveCall().isCalling?(this.enableBtn(["drop"]),this.disabledBtn(["answer","make","conference","transfer","cancel","hold","consult","single","dest"])):(this.enableBtn(["answer","drop"]),this.disabledBtn(["make","conference","transfer","cancel","hold","consult","single","dest"]))},t.ui.handleConference=function(){this.enableBtn(["drop"]),this.disabledBtn(["answer","make","conference","transfer","cancel","hold","consult","single","dest"])},t.ui.refreshButtonStatus=function(){var e=n.length,t=this.getActiveCall();0===e?(this.enableBtn(["make"]),this.disabledBtn(["answer","drop","hold","consult","conference","transfer","cancel","single","dest"])):1===e?"established"===t.state||"held"===t.state?(this.enableBtn(["drop","hold","consult","single","dest"]),this.disabledBtn(["answer","make","conference","transfer","cancel"])):"delivered"===t.state?this.handleDeliveredState():"conferenced"===t.state&&this.handleConference():2===e&&("delivered"===t.state?this.handleDeliveredState():"conferenced"===t.state?this.handleConference():(this.enableBtn(["hold","conference","transfer","cancel"]),this.disabledBtn(["drop","answer","make","consult","single","dest"])))},t.ui.getActiveCall=function(){return 0===n.length?-1:n[n.length-1]},t.ui.setAgentStateReady=function(){this.removePendingMode(),e("#well-changestate").val("Ready:")},t.ui.retrieveCall=function(){var e=this.getActiveCall();-1!==e&&"held"===e.state&&t.retrieveCall(e.callId)},t.ui.setAgentStateNotReady=function(){this.removePendingMode(),e("#well-changestate").val("NotReady:1")},t.ui.agentLoggedOn=function(t){this.enableBtn(["make","changestate"]),this.status.receiveEvent(t.eventName),t.deviceId="string"==typeof t.deviceId?t.deviceId.split("@")[0]:"",e("#well-device").text(t.deviceId),e("#well-login-info").hide(),e("#well-login").hide(),e("#well-logout").removeClass("well-dn")},t.ui.agentReady=function(e){this.setAgentStateReady(),this.status.receiveEvent(e.eventName)},t.ui.agentNotReady=function(e){this.setAgentStateNotReady(),this.status.receiveEvent(e.eventName,e.reason)},t.ui.agentLoggedOff=function(l){n=[],this.removePendingMode(),this.status.receiveEvent(l.eventName),t.ui.disabledBtn(["answer","drop","hold","make","consult","conference","transfer","cancel","single"]),e("#well-login-info").show(),e("#well-login").show(),e("#well-logout").addClass("well-dn")},t.ui.originated=function(e){this.status.receiveEvent(e.eventName),n.push({state:"originated",callId:e.callId,deviceId:e.deviceId,isCalling:!0})},t.ui.delivered=function(e){if(this.status.receiveEvent(e.eventName),e.isCalling){var l=t.findItem(n,"deviceId",e.deviceId);if(-1===l)return;l=n[l],l.state="delivered"}else this.enableBtn(["answer","drop"]),n.push({state:"delivered",callId:e.callId,deviceId:e.deviceId,isCalling:!1}),e.autoAnswer&&t.ctrl.answerCall();this.refreshButtonStatus()},t.ui.established=function(e){var l=t.findItem(n,"deviceId",e.deviceId);-1!==l&&(l=n[l],l.state="established",this.status.receiveEvent(e.eventName),this.refreshButtonStatus(),this.clearPhoneNumber())},t.ui.clearAllCalls=function(){n=[],this.refreshButtonStatus()},t.ui.connectionCleared=function(e){var l=t.findItem(n,"deviceId",e.deviceId);-1!==l&&(this.removeOneCall(l),2!==n.length&&this.status.receiveEvent(e.eventName),this.refreshButtonStatus(),this.retrieveCall(),e.isClearAll&&this.clearAllCalls())},t.ui.held=function(l){var a=t.findItem(n,"deviceId",l.deviceId),i=this.getActiveCall();-1!==a&&(a=n[a],a.state="held",this.status.receiveEvent(l.eventName),a.deviceId===i.deviceId&&e("#well-hold").text("取回"),this.refreshButtonStatus())},t.ui.retrieved=function(l){var a=t.findItem(n,"deviceId",l.deviceId);-1!==a&&(a=n[a],a.state="established",this.status.receiveEvent(l.eventName),e("#well-hold").text("保持"),this.refreshButtonStatus())},t.ui.conferenced=function(e){for(var t=0;t<n.length;t++)n[t].callId=e.callId,n[t].state="conferenced";this.status.receiveEvent(e.eventName),this.refreshButtonStatus()},t.ui.agentWorkingAfterCall=function(e){this.removePendingMode(),this.status.receiveEvent(e.eventName)},t.ui.createWebNotification=function(e){window.Notification&&Notification.requestPermission(function(l){console.log(l),t.ui.webNotification=new Notification(e,{body:"wellClient 提醒",icon:"public/img/warning.png",tag:"wellClient"}),t.ui.webNotification.onclick=function(){t.ui.webNotification.close(),t.ui.webNotification=null}})},l.on("click",".well-btn",function(l){var n=e(l.currentTarget),a=n.attr("id");n.hasClass("well-disabled")||a&&t.ctrl.beforeDeliver(a)}),l.on("change","#well-dest",function(l){if($select=e("#well-dest"),!$select.hasClass("well-disabled")){var n=$select.val();if(n=e.trim(n)){var a=t.ui.getActiveCall();-1!==a&&(t.singleStepTransfer(a.callId,n),$select.val(""))}}}),t.ctrl={},t.ctrl.beforeDeliver=function(e){clearTimeout(t.ctrl.timeoutId),function(e){t.ctrl.timeoutId=setTimeout(function(){t.ctrl.deliverMethod(e)},500)}(e)},t.ctrl.deliverMethod=function(e){switch(e){case"well-make":return t.ctrl.makeCall();case"well-answer":return t.ctrl.answerCall();case"well-drop":return t.ctrl.dropCall();case"well-hold":return t.ctrl.holdCall();case"well-single":return t.ctrl.singleCall();case"well-consult":return t.ctrl.consultCall();case"well-cancel":return t.ctrl.cancelCall();case"well-transfer":return t.ctrl.transferCall();case"well-conference":return t.ctrl.conferenceCall();case"well-logout":return t.ctrl.logout();case"well-login":return t.ctrl.login();default:return}},t.ctrl.makeCall=function(){var e=t.ui.getPhoneNumber();!1!==e&&t.makeCall(e)},t.ctrl.answerCall=function(){var e=t.ui.getActiveCall();-1!==e&&t.answerCall(e.callId)},t.ctrl.dropCall=function(){var e=t.ui.getActiveCall();-1!==e&&t.dropConnection(e.callId)},t.ctrl.holdCall=function(){var l=t.ui.getActiveCall();if(-1!==l){"保持"===e("#well-hold").text()?t.holdCall(l.callId):t.retrieveCall(l.callId)}},t.ctrl.singleCall=function(){var e=t.ui.getPhoneNumber();if(!1!==e){var l=t.ui.getActiveCall();-1!==l&&t.singleStepTransfer(l.callId,e)}},t.ctrl.consultCall=function(){var e=t.ui.getPhoneNumber();if(!1!==e){var l=t.ui.getActiveCall();-1!==l&&t.consult(l.callId,e)}},t.ctrl.cancelCall=function(){var e=t.ui.getActiveCall();if(-1!==e&&2===n.length){var l=n[0];t.cancelConsult(l.callId,e.callId)}},t.ctrl.transferCall=function(){var e=t.ui.getActiveCall();if(-1!==e&&2===n.length){var l=n[0];t.transferCall(l.callId,e.callId)}},t.ctrl.conferenceCall=function(){var e=t.ui.getActiveCall();if(-1!==e&&2===n.length){var l=n[0];t.conference(l.callId,e.callId)}},t.ctrl.logout=function(){t.logout()},t.ctrl.login=function(){var l=e("#well-login"),n=e("#well-loading"),a=e("#well-code").val(),i=e("#well-password").val(),s=e("#well-namespace").val(),r=e("#well-deviceId").val();if(!(a&&i&&s&&r))return void alert("工号，密码，域名，分机号都是必填项");n.removeClass("well-dn"),l.hide(),t.agentLogin({jobNumber:a,password:i,domain:s,ext:r,agentMode:"NotReady",loginMode:"force"}).done(function(e){window.localStorage&&(localStorage.setItem("code",a),localStorage.setItem("password",i),localStorage.setItem("namespace",s),localStorage.setItem("deviceId",r))}).fail(function(e){var l={eventName:"loginFailed",status:e.status,responseText:e.responseText};t.triggerInnerOn(l)}).always(function(){t.isLogined()||l.show(),n.addClass("well-dn"),l.removeAttr("disabled")})}}($,wellClient);